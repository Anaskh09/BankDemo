<%
/* ── Server-side helpers ── */
function fmtAmount(a) {
  return parseFloat(a).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}
function fmtTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}
function sign(type) {
  return type === 'credit' ? '+' : '−';
}
function typeLabel(t) {
  return t === 'credit' ? 'Crédit' : t === 'debit' ? 'Débit' : 'Virement';
}
function highlight(text, term) {
  if (!term || !text) return text || '';
  var escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return String(text).replace(new RegExp('(' + escaped + ')', 'gi'), '<mark>$1</mark>');
}

/* ── Compute summary stats ── */
var totalCredit = 0, countCredit = 0;
var totalDebit  = 0, countDebit  = 0;
var totalTransfer = 0, countTransfer = 0;
transactions.forEach(function(tx) {
  var a = parseFloat(tx.amount) || 0;
  if (tx.type === 'credit')   { totalCredit   += a; countCredit++;   }
  if (tx.type === 'debit')    { totalDebit    += a; countDebit++;    }
  if (tx.type === 'transfer') { totalTransfer += a; countTransfer++; }
});
%>
<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Transactions — BankDemo</title>
  <%- include('partials/head') %>
</head>
<body>

<div class="layout">

  <%- include('partials/navbar', { activePage: 'transactions' }) %>

  <!-- ══════════ MAIN ══════════ -->
  <div class="main">

    <header class="topbar">
      <div style="display:flex; align-items:center; gap:16px;">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="2" y1="5" x2="18" y2="5"/>
            <line x1="2" y1="10" x2="18" y2="10"/>
            <line x1="2" y1="15" x2="18" y2="15"/>
          </svg>
        </button>
        <div class="topbar-left">
          <h1>Transactions</h1>
          <p>Historique complet de votre compte</p>
        </div>
      </div>
    </header>

    <div class="page-body">

      <!-- ── SUMMARY CARDS ── -->
      <div class="summary-row">

        <div class="summary-card total">
          <div class="summary-label">
            <span class="summary-label-dot gold"></span>
            Total opérations
          </div>
          <div class="summary-value"><%= transactions.length %><small>txn</small></div>
          <div class="summary-count">Depuis le début</div>
        </div>

        <div class="summary-card credit">
          <div class="summary-label">
            <span class="summary-label-dot green"></span>
            Crédits reçus
          </div>
          <div class="summary-value"><%= fmtAmount(totalCredit) %><small>MAD</small></div>
          <div class="summary-count"><%= countCredit %> opération<%= countCredit !== 1 ? 's' : '' %></div>
        </div>

        <div class="summary-card debit">
          <div class="summary-label">
            <span class="summary-label-dot red"></span>
            Débits effectués
          </div>
          <div class="summary-value"><%= fmtAmount(totalDebit) %><small>MAD</small></div>
          <div class="summary-count"><%= countDebit %> opération<%= countDebit !== 1 ? 's' : '' %></div>
        </div>

        <div class="summary-card transfer">
          <div class="summary-label">
            <span class="summary-label-dot blue"></span>
            Virements
          </div>
          <div class="summary-value"><%= fmtAmount(totalTransfer) %><small>MAD</small></div>
          <div class="summary-count"><%= countTransfer %> opération<%= countTransfer !== 1 ? 's' : '' %></div>
        </div>

      </div>

      <!-- ── TOOLBAR ── -->
      <div class="toolbar">
        <form action="/transactions" method="GET" style="display:flex; gap:10px; flex:1; min-width:0;">
          <div class="search-wrap">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
              <circle cx="6.5" cy="6.5" r="4.5"/>
              <path d="M10 10l3.5 3.5" stroke-linecap="round"/>
            </svg>
            <input
              type="text"
              name="search"
              class="search-input"
              placeholder="Rechercher un bénéficiaire, une note…"
              value="<%= search %>"
              autocomplete="off"
              id="searchInput"
            />
          </div>
          <button type="submit" class="btn-search">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.4">
              <circle cx="6" cy="6" r="4"/>
              <path d="M10 10l3 3" stroke-linecap="round"/>
            </svg>
            Rechercher
          </button>
          <% if (search) { %>
          <a href="/transactions" class="btn-outline" style="padding:10px 16px; font-size:12px;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M2 2l8 8M10 2l-8 8"/>
            </svg>
            Effacer
          </a>
          <% } %>
        </form>

        <div class="toolbar-right">
          <div class="filter-chips">
            <span class="chip active" data-filter="all"      onclick="filterTable(this, 'all')">Tous</span>
            <span class="chip"        data-filter="credit"   onclick="filterTable(this, 'credit')">Crédits</span>
            <span class="chip"        data-filter="debit"    onclick="filterTable(this, 'debit')">Débits</span>
            <span class="chip"        data-filter="transfer" onclick="filterTable(this, 'transfer')">Virements</span>
          </div>
        </div>
      </div>

      <!-- ── TABLE ── -->
      <div class="table-card">
        <div class="table-head-bar">
          <h2>
            <% if (search) { %>
              Résultats pour «&nbsp;<em style="color:var(--gold-light);font-style:italic;"><%= search %></em>&nbsp;»
            <% } else { %>
              Toutes les transactions
            <% } %>
          </h2>
          <span class="result-badge" id="visibleCount">
            <%= transactions.length %> résultat<%= transactions.length !== 1 ? 's' : '' %>
          </span>
        </div>

        <% if (transactions.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="30" height="30" viewBox="0 0 30 30" fill="none" stroke="currentColor" stroke-width="1.2">
              <rect x="3" y="5" width="24" height="20" rx="2"/>
              <path d="M3 11h24M9 17h4M9 21h2"/>
            </svg>
          </div>
          <h3><% if (search) { %>Aucun résultat<% } else { %>Aucune transaction<% } %></h3>
          <p>
            <% if (search) { %>
              Aucune transaction ne correspond à «&nbsp;<strong style="color:var(--text-mid);"><%= search %></strong>&nbsp;».<br>
              Essayez un autre terme.
            <% } else { %>
              Votre historique est vide pour le moment.<br>
              Effectuez un virement pour voir vos premières transactions.
            <% } %>
          </p>
          <% if (search) { %>
            <a href="/transactions">← Afficher toutes les transactions</a>
          <% } else { %>
            <a href="/transfer">Effectuer un virement →</a>
          <% } %>
        </div>

        <% } else { %>

        <table class="tx-table" id="txTable">
          <thead>
            <tr>
              <th class="col-id">#</th>
              <th>Type</th>
              <th>Bénéficiaire</th>
              <th class="col-note">Note</th>
              <th>Montant</th>
              <th class="col-date">Date</th>
            </tr>
          </thead>
          <tbody>
            <% transactions.forEach(function(tx, i) { %>
            <tr data-type="<%= tx.type %>">
              <td class="col-id"><span class="tx-index"><%= i + 1 %></span></td>
              <td>
                <span class="badge <%= tx.type %>">
                  <span class="badge-dot"></span>
                  <%= typeLabel(tx.type) %>
                </span>
              </td>
              <td>
                <div class="tx-beneficiary"><%- highlight(tx.beneficiary, search) %></div>
              </td>
              <td class="col-note">
                <div class="tx-note"><%- highlight(tx.note || '—', search) %></div>
              </td>
              <td>
                <div class="tx-amount <%= tx.type %>">
                  <%= sign(tx.type) %><%= fmtAmount(tx.amount) %>
                  <span class="tx-currency">MAD</span>
                </div>
              </td>
              <td class="col-date">
                <div class="tx-date"><%= fmtDate(tx.created_at) %></div>
                <div class="tx-time"><%= fmtTime(tx.created_at) %></div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>

        <div class="table-footer">
          <span id="footerCount"><%= transactions.length %> transaction<%= transactions.length !== 1 ? 's' : '' %> au total</span>
          <a href="#" class="export-link" onclick="exportCSV(); return false;">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M6.5 1v8M3.5 6l3 3 3-3"/>
              <path d="M1 10v1a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-1"/>
            </svg>
            Exporter CSV
          </a>
        </div>

        <% } %>
      </div>

    </div><!-- end page-body -->
  </div><!-- end main -->
</div><!-- end layout -->

<%- include('partials/footer') %>

<script>
  /* ── Client-side type filter ── */
  function filterTable(chip, type) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    const rows = document.querySelectorAll('#txTable tbody tr');
    let visible = 0;
    rows.forEach(row => {
      const match = type === 'all' || row.dataset.type === type;
      row.style.display = match ? '' : 'none';
      if (match) {
        visible++;
        row.style.animationDelay = (visible * 0.03) + 's';
      }
    });
    const badge  = document.getElementById('visibleCount');
    const footer = document.getElementById('footerCount');
    if (badge)  badge.textContent  = visible + ' résultat' + (visible !== 1 ? 's' : '');
    if (footer) footer.textContent = visible + ' transaction' + (visible !== 1 ? 's' : '') + (type !== 'all' ? ' filtrée' + (visible !== 1 ? 's' : '') : ' au total');
  }

  /* ── Export CSV ── */
  function exportCSV() {
    const table = document.getElementById('txTable');
    if (!table) return;
    const rows = [['#','Type','Bénéficiaire','Note','Montant (MAD)','Date'].join(';')];
    table.querySelectorAll('tbody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const cells = row.querySelectorAll('td');
      const vals  = [
        cells[0]?.textContent?.trim(),
        cells[1]?.textContent?.trim(),
        cells[2]?.textContent?.trim(),
        cells[3]?.textContent?.trim(),
        cells[4]?.textContent?.trim()?.replace(/\s/g,'').replace('MAD',''),
        cells[5]?.textContent?.trim()?.replace('\n',' '),
      ];
      rows.push(vals.map(v => `"${v}"`).join(';'));
    });
    const blob = new Blob(['\uFEFF' + rows.join('\n')], { type:'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'transactions_bankdemo.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  /* ── Search shortcut (Ctrl+K) ── */
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('searchInput')?.focus();
    }
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transactions — BankDemo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold:        #b8965a;
      --gold-light:  #d4b07a;
      --gold-pale:   rgba(184,150,90,0.08);
      --dark:        #0d0d0d;
      --dark-2:      #131313;
      --dark-3:      #1a1a1a;
      --border:      rgba(255,255,255,0.07);
      --border-gold: rgba(184,150,90,0.2);
      --text:        #e8e0d4;
      --text-dim:    #7a7470;
      --text-mid:    #a09890;
      --green:       #4caf82;
      --green-bg:    rgba(76,175,130,0.1);
      --red:         #c0504a;
      --red-bg:      rgba(192,80,74,0.1);
      --blue:        #5a8fb8;
      --blue-bg:     rgba(90,143,184,0.1);
      --sidebar-w:   260px;
    }

    html, body {
      height: 100%;
      background: var(--dark);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-weight: 300;
      font-size: 14px;
    }

    /* ══════════════ LAYOUT ══════════════ */
    .layout { display: flex; min-height: 100vh; }

    /* ══════════════ SIDEBAR ══════════════ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--dark-2);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; bottom: 0;
      z-index: 100;
      transition: transform 0.3s ease;
    }
    .sidebar-logo {
      padding: 32px 28px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .logo-icon {
      width: 36px; height: 36px;
      border: 1px solid rgba(184,150,90,0.45); border-radius: 2px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px; color: var(--gold); flex-shrink: 0;
    }
    .logo-text {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px; font-weight: 300; letter-spacing: 0.06em;
    }
    .logo-text span { color: var(--gold); }

    .sidebar-nav { flex: 1; padding: 24px 0; overflow-y: auto; }
    .nav-section-label {
      font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase;
      color: var(--text-dim); padding: 0 28px;
      margin-bottom: 8px; margin-top: 20px;
    }
    .nav-section-label:first-child { margin-top: 0; }
    .nav-item {
      display: flex; align-items: center; gap: 13px;
      padding: 11px 28px; color: var(--text-mid);
      text-decoration: none; font-size: 13.5px; font-weight: 300;
      position: relative; transition: color 0.2s, background 0.2s;
    }
    .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s; }
    .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
    .nav-item:hover svg { opacity: 1; }
    .nav-item.active { color: var(--gold-light); background: var(--gold-pale); }
    .nav-item.active::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0;
      width: 2px; background: var(--gold); border-radius: 0 1px 1px 0;
    }
    .nav-item.active svg { opacity: 1; color: var(--gold); }

    .sidebar-footer { padding: 20px 28px; border-top: 1px solid var(--border); }
    .user-chip { display: flex; align-items: center; gap: 12px; }
    .user-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, var(--gold) 0%, #7a5c2e 100%);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 15px; color: var(--dark); flex-shrink: 0;
    }
    .user-info { overflow: hidden; }
    .user-email { font-size: 12px; color: var(--text-mid); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--gold); margin-top: 2px; }
    .logout-btn {
      margin-left: auto; color: var(--text-dim);
      background: none; border: none; cursor: pointer; padding: 4px;
      transition: color 0.2s; flex-shrink: 0;
    }
    .logout-btn:hover { color: var(--red); }

    /* ══════════════ MAIN ══════════════ */
    .main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; }

    .topbar {
      background: var(--dark-2); border-bottom: 1px solid var(--border);
      padding: 0 40px; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
    }
    .topbar-left h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px; font-weight: 300;
    }
    .topbar-left p { font-size: 12px; color: var(--text-dim); margin-top: 1px; }
    .hamburger {
      display: none; background: none; border: none;
      color: var(--text-mid); cursor: pointer; padding: 4px;
    }

    /* ══════════════ PAGE BODY ══════════════ */
    .page-body { padding: 36px 40px 60px; flex: 1; display: flex; flex-direction: column; gap: 24px; }

    /* ── SUMMARY CARDS ── */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      animation: fadeUp 0.4s ease both;
    }

    .summary-card {
      background: var(--dark-3);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 20px 22px;
      position: relative;
      overflow: hidden;
    }
    .summary-card::before {
      content: '';
      position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
      border-radius: 0 0 4px 4px;
    }
    .summary-card.total::before  { background: linear-gradient(90deg, transparent, var(--gold), transparent); }
    .summary-card.credit::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
    .summary-card.debit::before  { background: linear-gradient(90deg, transparent, var(--red), transparent); }
    .summary-card.transfer::before { background: linear-gradient(90deg, transparent, var(--blue), transparent); }

    .summary-label {
      font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase;
      color: var(--text-dim); margin-bottom: 12px;
      display: flex; align-items: center; gap: 7px;
    }
    .summary-label-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    }
    .summary-label-dot.gold     { background: var(--gold); }
    .summary-label-dot.green    { background: var(--green); }
    .summary-label-dot.red      { background: var(--red); }
    .summary-label-dot.blue     { background: var(--blue); }

    .summary-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px; font-weight: 300; color: var(--text); line-height: 1;
    }
    .summary-value small { font-size: 13px; color: var(--text-dim); margin-left: 4px; }
    .summary-count { font-size: 11px; color: var(--text-dim); margin-top: 6px; }

    /* ── TOOLBAR ── */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; flex-wrap: wrap;
      animation: fadeUp 0.4s ease 0.08s both;
    }

    .search-wrap {
      position: relative; flex: 1; min-width: 220px; max-width: 400px;
    }
    .search-wrap svg {
      position: absolute; left: 13px; top: 50%; transform: translateY(-50%);
      color: var(--text-dim); pointer-events: none;
      transition: color 0.2s;
    }
    .search-wrap:focus-within svg { color: var(--gold); }

    .search-input {
      width: 100%;
      background: var(--dark-3);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 10px 12px 10px 38px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px; font-weight: 300;
      color: var(--text); outline: none;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
      border-color: rgba(184,150,90,0.45);
      background: rgba(184,150,90,0.04);
      box-shadow: 0 0 0 3px rgba(184,150,90,0.07);
    }
    .search-input::placeholder { color: var(--text-dim); }

    .btn-search {
      padding: 10px 20px;
      background: var(--gold); border: none; border-radius: 2px;
      font-family: 'DM Sans', sans-serif;
      font-size: 12px; font-weight: 400;
      letter-spacing: 0.14em; text-transform: uppercase;
      color: var(--dark); cursor: pointer;
      display: flex; align-items: center; gap: 7px;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn-search:hover { background: var(--gold-light); box-shadow: 0 3px 16px rgba(184,150,90,0.2); }

    .toolbar-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }

    /* Filter chips */
    .filter-chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--dark-3);
      font-size: 11px; color: var(--text-mid);
      cursor: pointer; transition: all 0.2s;
      letter-spacing: 0.04em;
    }
    .chip:hover { border-color: var(--border-gold); color: var(--gold-light); }
    .chip.active { background: var(--gold-pale); border-color: var(--border-gold); color: var(--gold-light); }

    /* ── TABLE ── */
    .table-card {
      background: var(--dark-3);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      animation: fadeUp 0.4s ease 0.15s both;
    }

    .table-head-bar {
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .table-head-bar h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 19px; font-weight: 300;
    }
    .result-badge {
      font-size: 11px;
      background: var(--gold-pale); color: var(--gold-light);
      border: 1px solid var(--border-gold);
      padding: 3px 10px; border-radius: 20px; letter-spacing: 0.05em;
    }

    /* Table */
    .tx-table { width: 100%; border-collapse: collapse; }

    .tx-table thead { background: rgba(255,255,255,0.02); }
    .tx-table th {
      padding: 11px 20px;
      text-align: left;
      font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--text-dim); font-weight: 400;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    .tx-table th:last-child { text-align: right; }

    .tx-table tbody tr {
      border-bottom: 1px solid rgba(255,255,255,0.035);
      transition: background 0.15s;
      cursor: default;
      animation: fadeUp 0.3s ease both;
    }
    .tx-table tbody tr:last-child { border-bottom: none; }
    .tx-table tbody tr:hover { background: rgba(255,255,255,0.025); }

    .tx-table td { padding: 15px 20px; vertical-align: middle; }
    .tx-table td:last-child { text-align: right; }

    /* Row index */
    .tx-index { font-size: 11px; color: var(--text-dim); font-variant-numeric: tabular-nums; }

    /* Type badge */
    .badge {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 11px; padding: 4px 11px; border-radius: 20px;
      letter-spacing: 0.04em; font-weight: 400; white-space: nowrap;
    }
    .badge-dot { width: 5px; height: 5px; border-radius: 50%; }
    .badge.credit   { background: var(--green-bg);  color: var(--green); }
    .badge.debit    { background: var(--red-bg);     color: var(--red);   }
    .badge.transfer { background: var(--blue-bg);    color: var(--blue);  }
    .badge.credit   .badge-dot { background: var(--green); }
    .badge.debit    .badge-dot { background: var(--red); }
    .badge.transfer .badge-dot { background: var(--blue); }

    /* Beneficiary */
    .tx-beneficiary { font-size: 13.5px; color: var(--text); font-weight: 400; }
    .tx-note { font-size: 11px; color: var(--text-dim); margin-top: 3px; line-height: 1.4; }

    /* Amount */
    .tx-amount {
      font-family: 'Cormorant Garamond', serif;
      font-size: 19px; font-weight: 400;
      letter-spacing: 0.01em; white-space: nowrap;
    }
    .tx-amount.credit   { color: var(--green); }
    .tx-amount.debit    { color: var(--red); }
    .tx-amount.transfer { color: var(--text-mid); }

    .tx-currency { font-size: 11px; margin-left: 4px; opacity: 0.7; }

    /* Date */
    .tx-date { font-size: 12px; color: var(--text-mid); white-space: nowrap; }
    .tx-time { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

    /* ── EMPTY STATE ── */
    .empty-state {
      padding: 72px 28px; text-align: center; color: var(--text-dim);
    }
    .empty-icon {
      width: 72px; height: 72px; border-radius: 50%;
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 24px; opacity: 0.35;
    }
    .empty-state h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px; font-weight: 300; color: var(--text-mid); margin-bottom: 10px;
    }
    .empty-state p { font-size: 13px; line-height: 1.7; max-width: 320px; margin: 0 auto 20px; }
    .empty-state a {
      font-size: 12px; color: var(--gold); text-decoration: none;
      letter-spacing: 0.05em;
    }
    .empty-state a:hover { color: var(--gold-light); }

    /* ── PAGINATION INFO ── */
    .table-footer {
      padding: 14px 28px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      font-size: 12px; color: var(--text-dim);
    }
    .export-link {
      display: flex; align-items: center; gap: 6px;
      color: var(--text-dim); text-decoration: none; font-size: 12px;
      transition: color 0.2s;
    }
    .export-link:hover { color: var(--gold-light); }

    /* ══════════════ ANIMATIONS ══════════════ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Stagger table rows */
    .tx-table tbody tr:nth-child(1) { animation-delay: 0.05s; }
    .tx-table tbody tr:nth-child(2) { animation-delay: 0.08s; }
    .tx-table tbody tr:nth-child(3) { animation-delay: 0.11s; }
    .tx-table tbody tr:nth-child(4) { animation-delay: 0.14s; }
    .tx-table tbody tr:nth-child(5) { animation-delay: 0.17s; }
    .tx-table tbody tr:nth-child(6) { animation-delay: 0.20s; }
    .tx-table tbody tr:nth-child(7) { animation-delay: 0.23s; }
    .tx-table tbody tr:nth-child(8) { animation-delay: 0.26s; }

    /* ══════════════ RESPONSIVE ══════════════ */
    @media (max-width: 1100px) {
      .summary-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 860px) {
      :root { --sidebar-w: 0px; }
      .sidebar { transform: translateX(-260px); }
      .sidebar.open { transform: translateX(0); width: 260px; }
      .main { margin-left: 0; }
      .hamburger { display: flex; }
      .page-body { padding: 24px 20px 48px; }
      .topbar { padding: 0 20px; }
      .summary-row { grid-template-columns: 1fr 1fr; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .search-wrap { max-width: 100%; }
      /* Hide less important columns on mobile */
      .col-note, .col-id { display: none; }
    }
    @media (max-width: 540px) {
      .summary-row { grid-template-columns: 1fr; }
      .col-date { display: none; }
    }

    .sidebar-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.6); z-index: 99;
    }
    .sidebar-overlay.show { display: block; }

    /* Search highlight */
    mark {
      background: rgba(184,150,90,0.25);
      color: var(--gold-light);
      border-radius: 2px;
      padding: 0 2px;
    }
  </style>
</head>
<body>

<%
/* ── Server-side helpers ── */
function fmtAmount(a) {
  return parseFloat(a).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtDate(d) {
  if (!d) return '';
  const date = new Date(d);
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}
function fmtTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}
function sign(type) {
  return type === 'credit' ? '+' : '−';
}
function typeLabel(t) {
  return t === 'credit' ? 'Crédit' : t === 'debit' ? 'Débit' : 'Virement';
}

/* ── Compute summary stats ── */
var totalCredit   = 0, countCredit   = 0;
var totalDebit    = 0, countDebit    = 0;
var totalTransfer = 0, countTransfer = 0;
transactions.forEach(function(tx) {
  var a = parseFloat(tx.amount) || 0;
  if (tx.type === 'credit')   { totalCredit   += a; countCredit++;   }
  if (tx.type === 'debit')    { totalDebit    += a; countDebit++;    }
  if (tx.type === 'transfer') { totalTransfer += a; countTransfer++; }
});

/* Highlight search term */
function highlight(text, term) {
  if (!term || !text) return text || '';
  var escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return String(text).replace(new RegExp('(' + escaped + ')', 'gi'), '<mark>$1</mark>');
}
%>

<div class="layout">

  <!-- ═══════════════ SIDEBAR ═══════════════ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">B</div>
      <div class="logo-text">Bank<span>Demo</span></div>
    </div>

    <nav class="sidebar-nav">
      <p class="nav-section-label">Principal</p>

      <a href="/dashboard" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <rect x="1" y="1" width="6" height="6" rx="1"/>
          <rect x="9" y="1" width="6" height="6" rx="1"/>
          <rect x="1" y="9" width="6" height="6" rx="1"/>
          <rect x="9" y="9" width="6" height="6" rx="1"/>
        </svg>
        Tableau de bord
      </a>

      <a href="/transactions" class="nav-item active">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <path d="M2 4h12M2 8h8M2 12h5"/>
          <path d="M13 9l2 2-2 2"/><path d="M15 11h-4"/>
        </svg>
        Transactions
      </a>

      <a href="/transfer" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <path d="M1 5h10M8 2l3 3-3 3"/>
          <path d="M15 11H5m3 3-3-3 3-3"/>
        </svg>
        Virement
      </a>

      <p class="nav-section-label">Compte</p>

      <a href="/messages" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <rect x="1" y="3" width="14" height="10" rx="1"/>
          <path d="M1 5l7 4 7-4"/>
        </svg>
        Messages
      </a>

      <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
      <p class="nav-section-label">Administration</p>
      <a href="/admin" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <circle cx="8" cy="5" r="3"/>
          <path d="M1 14c0-3.314 3.134-6 7-6s7 2.686 7 6"/>
        </svg>
        Admin Panel
      </a>
      <% } %>
    </nav>

    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar">
          <%= typeof user !== 'undefined' && user ? user.email.charAt(0).toUpperCase() : 'U' %>
        </div>
        <div class="user-info">
          <div class="user-email"><%= typeof user !== 'undefined' && user ? user.email : '' %></div>
          <div class="user-role"><%= typeof user !== 'undefined' && user ? user.role : 'user' %></div>
        </div>
        <a href="/logout" class="logout-btn" title="Se déconnecter">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
            <path d="M6 2H3a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h3"/>
            <path d="M11 11l3-3-3-3"/><line x1="14" y1="8" x2="6" y2="8"/>
          </svg>
        </a>
      </div>
    </div>
  </aside>

  <div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>

  <!-- ═══════════════ MAIN ═══════════════ -->
  <div class="main">

    <header class="topbar">
      <div style="display:flex; align-items:center; gap:16px;">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="2" y1="5" x2="18" y2="5"/>
            <line x1="2" y1="10" x2="18" y2="10"/>
            <line x1="2" y1="15" x2="18" y2="15"/>
          </svg>
        </button>
        <div class="topbar-left">
          <h1>Transactions</h1>
          <p>Historique complet de votre compte</p>
        </div>
      </div>
    </header>

    <div class="page-body">

      <!-- ── SUMMARY CARDS ── -->
      <div class="summary-row">

        <div class="summary-card total">
          <div class="summary-label">
            <span class="summary-label-dot gold"></span>
            Total opérations
          </div>
          <div class="summary-value">
            <%= transactions.length %><small>txn</small>
          </div>
          <div class="summary-count">Depuis le début</div>
        </div>

        <div class="summary-card credit">
          <div class="summary-label">
            <span class="summary-label-dot green"></span>
            Crédits reçus
          </div>
          <div class="summary-value">
            <%= fmtAmount(totalCredit) %><small>MAD</small>
          </div>
          <div class="summary-count"><%= countCredit %> opération<%= countCredit !== 1 ? 's' : '' %></div>
        </div>

        <div class="summary-card debit">
          <div class="summary-label">
            <span class="summary-label-dot red"></span>
            Débits effectués
          </div>
          <div class="summary-value">
            <%= fmtAmount(totalDebit) %><small>MAD</small>
          </div>
          <div class="summary-count"><%= countDebit %> opération<%= countDebit !== 1 ? 's' : '' %></div>
        </div>

        <div class="summary-card transfer">
          <div class="summary-label">
            <span class="summary-label-dot blue"></span>
            Virements
          </div>
          <div class="summary-value">
            <%= fmtAmount(totalTransfer) %><small>MAD</small>
          </div>
          <div class="summary-count"><%= countTransfer %> opération<%= countTransfer !== 1 ? 's' : '' %></div>
        </div>

      </div>

      <!-- ── TOOLBAR ── -->
      <div class="toolbar">
        <form action="/transactions" method="GET" style="display:flex; gap:10px; flex:1; min-width:0;">
          <div class="search-wrap">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
              <circle cx="6.5" cy="6.5" r="4.5"/>
              <path d="M10 10l3.5 3.5" stroke-linecap="round"/>
            </svg>
            <input
              type="text"
              name="search"
              class="search-input"
              placeholder="Rechercher un bénéficiaire, une note…"
              value="<%= search %>"
              autocomplete="off"
              id="searchInput"
            />
          </div>
          <button type="submit" class="btn-search">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.4">
              <circle cx="6" cy="6" r="4"/><path d="M10 10l3 3" stroke-linecap="round"/>
            </svg>
            Rechercher
          </button>
          <% if (search) { %>
          <a href="/transactions" style="display:flex; align-items:center; gap:6px; padding:10px 16px; border:1px solid var(--border); border-radius:2px; color:var(--text-dim); text-decoration:none; font-size:12px; background:var(--dark-3); transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--text-dim)'">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M2 2l8 8M10 2l-8 8"/>
            </svg>
            Effacer
          </a>
          <% } %>
        </form>

        <div class="toolbar-right">
          <!-- Filter chips (client-side) -->
          <div class="filter-chips">
            <span class="chip active" data-filter="all" onclick="filterTable(this, 'all')">Tous</span>
            <span class="chip" data-filter="credit"   onclick="filterTable(this, 'credit')">Crédits</span>
            <span class="chip" data-filter="debit"    onclick="filterTable(this, 'debit')">Débits</span>
            <span class="chip" data-filter="transfer" onclick="filterTable(this, 'transfer')">Virements</span>
          </div>
        </div>
      </div>

      <!-- ── TABLE ── -->
      <div class="table-card">
        <div class="table-head-bar">
          <h2>
            <% if (search) { %>
              Résultats pour «&nbsp;<em style="color:var(--gold-light);font-style:italic;"><%= search %></em>&nbsp;»
            <% } else { %>
              Toutes les transactions
            <% } %>
          </h2>
          <span class="result-badge" id="visibleCount">
            <%= transactions.length %> résultat<%= transactions.length !== 1 ? 's' : '' %>
          </span>
        </div>

        <% if (transactions.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="30" height="30" viewBox="0 0 30 30" fill="none" stroke="currentColor" stroke-width="1.2">
              <rect x="3" y="5" width="24" height="20" rx="2"/>
              <path d="M3 11h24M9 17h4M9 21h2"/>
            </svg>
          </div>
          <h3><% if (search) { %>Aucun résultat<% } else { %>Aucune transaction<% } %></h3>
          <p>
            <% if (search) { %>
              Aucune transaction ne correspond à «&nbsp;<strong style="color:var(--text-mid);"><%= search %></strong>&nbsp;».<br>
              Essayez un autre terme de recherche.
            <% } else { %>
              Votre historique est vide pour le moment.<br>
              Effectuez un virement pour voir vos premières transactions.
            <% } %>
          </p>
          <% if (search) { %>
            <a href="/transactions">← Afficher toutes les transactions</a>
          <% } else { %>
            <a href="/transfer">Effectuer un virement →</a>
          <% } %>
        </div>

        <% } else { %>

        <table class="tx-table" id="txTable">
          <thead>
            <tr>
              <th class="col-id">#</th>
              <th>Type</th>
              <th>Bénéficiaire</th>
              <th class="col-note">Note</th>
              <th style="text-align:right;">Montant</th>
              <th class="col-date">Date</th>
            </tr>
          </thead>
          <tbody>
            <% transactions.forEach(function(tx, i) { %>
            <tr data-type="<%= tx.type %>">
              <td class="col-id"><span class="tx-index"><%= i + 1 %></span></td>
              <td>
                <span class="badge <%= tx.type %>">
                  <span class="badge-dot"></span>
                  <%= typeLabel(tx.type) %>
                </span>
              </td>
              <td>
                <div class="tx-beneficiary"><%- highlight(tx.beneficiary, search) %></div>
              </td>
              <td class="col-note">
                <div class="tx-note"><%- highlight(tx.note || '—', search) %></div>
              </td>
              <td>
                <div class="tx-amount <%= tx.type %>">
                  <%= sign(tx.type) %><%= fmtAmount(tx.amount) %>
                  <span class="tx-currency">MAD</span>
                </div>
              </td>
              <td class="col-date">
                <div class="tx-date"><%= fmtDate(tx.created_at) %></div>
                <div class="tx-time"><%= fmtTime(tx.created_at) %></div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>

        <div class="table-footer">
          <span id="footerCount"><%= transactions.length %> transaction<%= transactions.length !== 1 ? 's' : '' %> au total</span>
          <a href="#" class="export-link" onclick="exportCSV(); return false;">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M6.5 1v8M3.5 6l3 3 3-3"/>
              <path d="M1 10v1a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-1"/>
            </svg>
            Exporter CSV
          </a>
        </div>

        <% } %>
      </div>

    </div><!-- end page-body -->
  </div><!-- end main -->
</div><!-- end layout -->

<script>
  /* ── Mobile sidebar ── */
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
  }
  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
  }

  /* ── Client-side type filter ── */
  function filterTable(chip, type) {
    // Update chips
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');

    const rows = document.querySelectorAll('#txTable tbody tr');
    let visible = 0;
    rows.forEach((row, i) => {
      const match = type === 'all' || row.dataset.type === type;
      row.style.display = match ? '' : 'none';
      if (match) {
        visible++;
        row.style.animationDelay = (visible * 0.03) + 's';
      }
    });

    // Update count badge
    const badge = document.getElementById('visibleCount');
    if (badge) badge.textContent = visible + ' résultat' + (visible !== 1 ? 's' : '');
    const footer = document.getElementById('footerCount');
    if (footer) footer.textContent = visible + ' transaction' + (visible !== 1 ? 's' : '') + (type !== 'all' ? ' filtrée' + (visible !== 1 ? 's' : '') : ' au total');
  }

  /* ── Export CSV ── */
  function exportCSV() {
    const table = document.getElementById('txTable');
    if (!table) return;

    const rows = [];
    // Header
    rows.push(['#', 'Type', 'Bénéficiaire', 'Note', 'Montant (MAD)', 'Date'].join(';'));

    table.querySelectorAll('tbody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const cells = row.querySelectorAll('td');
      const num   = cells[0]?.textContent?.trim() || '';
      const type  = cells[1]?.textContent?.trim() || '';
      const benef = cells[2]?.textContent?.trim() || '';
      const note  = cells[3]?.textContent?.trim() || '';
      const amt   = cells[4]?.textContent?.trim()?.replace(/\s/g, '').replace('MAD','') || '';
      const date  = cells[5]?.textContent?.trim()?.replace('\n',' ') || '';
      rows.push([num, type, benef, note, amt, date].map(v => `"${v}"`).join(';'));
    });

    const blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'transactions_bankdemo.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  /* ── Live search shortcut (Ctrl+K / Cmd+K) ── */
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('searchInput')?.focus();
    }
  });
</script>

</body>
</html>

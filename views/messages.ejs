<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messages — BankDemo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold:        #b8965a;
      --gold-light:  #d4b07a;
      --gold-pale:   rgba(184,150,90,0.08);
      --dark:        #0d0d0d;
      --dark-2:      #131313;
      --dark-3:      #1a1a1a;
      --dark-4:      #222222;
      --border:      rgba(255,255,255,0.07);
      --border-gold: rgba(184,150,90,0.2);
      --text:        #e8e0d4;
      --text-dim:    #7a7470;
      --text-mid:    #a09890;
      --green:       #4caf82;
      --sidebar-w:   260px;
    }

    html, body {
      height: 100%;
      background: var(--dark);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-weight: 300;
      font-size: 14px;
    }

    /* ══════════════ LAYOUT ══════════════ */
    .layout { display: flex; min-height: 100vh; }

    /* ══════════════ SIDEBAR ══════════════ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--dark-2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-logo {
      padding: 32px 28px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .logo-icon {
      width: 36px; height: 36px;
      border: 1px solid rgba(184,150,90,0.45);
      border-radius: 2px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px; color: var(--gold); flex-shrink: 0;
    }
    .logo-text {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px; font-weight: 300; letter-spacing: 0.06em;
    }
    .logo-text span { color: var(--gold); }

    .sidebar-nav { flex: 1; padding: 24px 0; overflow-y: auto; }

    .nav-section-label {
      font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase;
      color: var(--text-dim); padding: 0 28px;
      margin-bottom: 8px; margin-top: 20px;
    }
    .nav-section-label:first-child { margin-top: 0; }

    .nav-item {
      display: flex; align-items: center; gap: 13px;
      padding: 11px 28px;
      color: var(--text-mid); text-decoration: none;
      font-size: 13.5px; font-weight: 300;
      position: relative;
      transition: color 0.2s, background 0.2s;
    }
    .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s; }
    .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
    .nav-item:hover svg { opacity: 1; }
    .nav-item.active { color: var(--gold-light); background: var(--gold-pale); }
    .nav-item.active::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0;
      width: 2px; background: var(--gold); border-radius: 0 1px 1px 0;
    }
    .nav-item.active svg { opacity: 1; color: var(--gold); }

    .sidebar-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--border);
    }
    .user-chip { display: flex; align-items: center; gap: 12px; }
    .user-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, var(--gold) 0%, #7a5c2e 100%);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 15px; color: var(--dark); flex-shrink: 0;
    }
    .user-info { overflow: hidden; }
    .user-email { font-size: 12px; color: var(--text-mid); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--gold); margin-top: 2px; }
    .logout-btn {
      margin-left: auto; color: var(--text-dim);
      background: none; border: none; cursor: pointer; padding: 4px;
      transition: color 0.2s; flex-shrink: 0;
    }
    .logout-btn:hover { color: #c0504a; }

    /* ══════════════ MAIN ══════════════ */
    .main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; }

    .topbar {
      background: var(--dark-2);
      border-bottom: 1px solid var(--border);
      padding: 0 40px; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
    }
    .topbar-left h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px; font-weight: 300;
    }
    .topbar-left p { font-size: 12px; color: var(--text-dim); margin-top: 1px; }

    .hamburger {
      display: none; background: none; border: none;
      color: var(--text-mid); cursor: pointer; padding: 4px;
    }

    /* ══════════════ PAGE ══════════════ */
    .page-body {
      padding: 36px 40px 60px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    /* ── NEW MESSAGE FORM ── */
    .compose-card {
      background: var(--dark-3);
      border: 1px solid var(--border-gold);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      animation: fadeUp 0.4s ease both;
    }
    .compose-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      opacity: 0.6;
    }

    .compose-head {
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .compose-head-icon {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--gold-pale);
      display: flex; align-items: center; justify-content: center;
      color: var(--gold);
    }
    .compose-head h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 19px; font-weight: 300;
    }
    .compose-head p { font-size: 12px; color: var(--text-dim); }

    .compose-body { padding: 24px 28px; }

    .compose-textarea {
      width: 100%;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 2px;
      padding: 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 300;
      color: var(--text);
      resize: vertical;
      min-height: 110px;
      outline: none;
      line-height: 1.6;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .compose-textarea:focus {
      border-color: rgba(184,150,90,0.45);
      background: rgba(184,150,90,0.04);
      box-shadow: 0 0 0 3px rgba(184,150,90,0.07);
    }
    .compose-textarea::placeholder { color: var(--text-dim); }

    .compose-footer {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 14px;
    }
    .compose-hint { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }

    .btn-send {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 11px 24px;
      background: var(--gold);
      border: none; border-radius: 2px;
      font-family: 'DM Sans', sans-serif;
      font-size: 12px; font-weight: 400;
      letter-spacing: 0.15em; text-transform: uppercase;
      color: var(--dark); cursor: pointer;
      position: relative; overflow: hidden;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    .btn-send::before {
      content: '';
      position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.4s ease;
    }
    .btn-send:hover::before { left: 100%; }
    .btn-send:hover { background: var(--gold-light); box-shadow: 0 4px 20px rgba(184,150,90,0.25); }
    .btn-send:active { transform: scale(0.98); }

    /* ── MESSAGES LIST ── */
    .messages-card {
      background: var(--dark-3);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      animation: fadeUp 0.4s ease 0.1s both;
    }

    .messages-head {
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .messages-head h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 19px; font-weight: 300;
    }

    .msg-count {
      font-size: 11px;
      background: var(--gold-pale);
      color: var(--gold-light);
      border: 1px solid var(--border-gold);
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 0.05em;
    }

    /* Individual message */
    .msg-list { display: flex; flex-direction: column; }

    .msg-item {
      display: flex;
      gap: 16px;
      padding: 22px 28px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      transition: background 0.15s;
      animation: fadeUp 0.35s ease both;
    }
    .msg-item:last-child { border-bottom: none; }
    .msg-item:hover { background: rgba(255,255,255,0.02); }

    .msg-avatar {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold) 0%, #7a5c2e 100%);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px; color: var(--dark);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .msg-body { flex: 1; min-width: 0; }

    .msg-header {
      display: flex; align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .msg-from {
      font-size: 13px; font-weight: 400;
      color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .msg-from .role-tag {
      display: inline-block;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gold);
      background: var(--gold-pale);
      border: 1px solid var(--border-gold);
      padding: 1px 7px; border-radius: 10px;
      margin-left: 8px; vertical-align: middle;
    }

    .msg-date {
      font-size: 11px; color: var(--text-dim);
      white-space: nowrap; flex-shrink: 0;
    }

    .msg-content {
      font-size: 13.5px; color: var(--text-mid);
      line-height: 1.65;
      word-break: break-word;
    }

    /* Decorative quote bar */
    .msg-item { position: relative; }
    .msg-item::before {
      content: '';
      position: absolute;
      left: 0; top: 22px; bottom: 22px;
      width: 2px;
      background: transparent;
      border-radius: 1px;
      transition: background 0.2s;
    }
    .msg-item:hover::before { background: rgba(184,150,90,0.25); }

    /* Empty state */
    .empty-state {
      padding: 64px 28px;
      text-align: center;
      color: var(--text-dim);
    }
    .empty-icon {
      width: 64px; height: 64px;
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 20px;
      opacity: 0.4;
    }
    .empty-state h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px; font-weight: 300; color: var(--text-mid);
      margin-bottom: 8px;
    }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* ══════════════ ANIMATIONS ══════════════ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Stagger message items */
    .msg-item:nth-child(1) { animation-delay: 0.05s; }
    .msg-item:nth-child(2) { animation-delay: 0.10s; }
    .msg-item:nth-child(3) { animation-delay: 0.15s; }
    .msg-item:nth-child(4) { animation-delay: 0.20s; }
    .msg-item:nth-child(5) { animation-delay: 0.25s; }

    /* ══════════════ RESPONSIVE ══════════════ */
    @media (max-width: 860px) {
      :root { --sidebar-w: 0px; }
      .sidebar { transform: translateX(-260px); }
      .sidebar.open { transform: translateX(0); width: 260px; }
      .main { margin-left: 0; }
      .hamburger { display: flex; }
      .page-body { padding: 24px 20px 48px; }
      .topbar { padding: 0 20px; }
      .compose-body, .compose-head, .compose-footer { padding-left: 20px; padding-right: 20px; }
      .msg-item { padding: 18px 20px; }
      .messages-head { padding: 16px 20px; }
    }

    .sidebar-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.6); z-index: 99;
    }
    .sidebar-overlay.show { display: block; }
  </style>
</head>
<body>

<div class="layout">

  <!-- ═══════════════ SIDEBAR ═══════════════ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">B</div>
      <div class="logo-text">Bank<span>Demo</span></div>
    </div>

    <nav class="sidebar-nav">
      <p class="nav-section-label">Principal</p>

      <a href="/dashboard" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <rect x="1" y="1" width="6" height="6" rx="1"/>
          <rect x="9" y="1" width="6" height="6" rx="1"/>
          <rect x="1" y="9" width="6" height="6" rx="1"/>
          <rect x="9" y="9" width="6" height="6" rx="1"/>
        </svg>
        Tableau de bord
      </a>

      <a href="/transactions" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <path d="M2 4h12M2 8h8M2 12h5"/>
          <path d="M13 9l2 2-2 2"/><path d="M15 11h-4"/>
        </svg>
        Transactions
      </a>

      <a href="/transfer" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <path d="M1 5h10M8 2l3 3-3 3"/>
          <path d="M15 11H5m3 3-3-3 3-3"/>
        </svg>
        Virement
      </a>

      <p class="nav-section-label">Compte</p>

      <a href="/messages" class="nav-item active">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <rect x="1" y="3" width="14" height="10" rx="1"/>
          <path d="M1 5l7 4 7-4"/>
        </svg>
        Messages
      </a>

      <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
      <p class="nav-section-label">Administration</p>
      <a href="/admin" class="nav-item">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
          <circle cx="8" cy="5" r="3"/>
          <path d="M1 14c0-3.314 3.134-6 7-6s7 2.686 7 6"/>
        </svg>
        Admin Panel
      </a>
      <% } %>
    </nav>

    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar">
          <%= typeof user !== 'undefined' && user ? user.email.charAt(0).toUpperCase() : 'U' %>
        </div>
        <div class="user-info">
          <div class="user-email"><%= typeof user !== 'undefined' && user ? user.email : '' %></div>
          <div class="user-role"><%= typeof user !== 'undefined' && user ? user.role : 'user' %></div>
        </div>
        <a href="/logout" class="logout-btn" title="Se déconnecter">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
            <path d="M6 2H3a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h3"/>
            <path d="M11 11l3-3-3-3"/><line x1="14" y1="8" x2="6" y2="8"/>
          </svg>
        </a>
      </div>
    </div>
  </aside>

  <div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>

  <!-- ═══════════════ MAIN ═══════════════ -->
  <div class="main">

    <header class="topbar">
      <div style="display:flex; align-items:center; gap:16px;">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="2" y1="5" x2="18" y2="5"/>
            <line x1="2" y1="10" x2="18" y2="10"/>
            <line x1="2" y1="15" x2="18" y2="15"/>
          </svg>
        </button>
        <div class="topbar-left">
          <h1>Messages</h1>
          <p>Correspondance avec votre conseiller</p>
        </div>
      </div>
    </header>

    <div class="page-body">

      <!-- ── COMPOSE ── -->
      <div class="compose-card">
        <div class="compose-head">
          <div class="compose-head-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M11 1l4 4-8 8H3v-4L11 1Z"/>
              <path d="M9 3l4 4"/>
            </svg>
          </div>
          <div>
            <h2>Nouveau message</h2>
            <p>Envoyez une demande ou une question à votre conseiller</p>
          </div>
        </div>
        <div class="compose-body">
          <form action="/messages" method="POST" id="composeForm">
            <textarea
              name="content"
              class="compose-textarea"
              placeholder="Bonjour, je souhaite obtenir des informations sur..."
              maxlength="1000"
              required
              id="msgTextarea"
            ></textarea>
            <div class="compose-footer">
              <span class="compose-hint">
                <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.2">
                  <circle cx="6.5" cy="6.5" r="5.5"/>
                  <line x1="6.5" y1="4" x2="6.5" y2="7"/>
                  <circle cx="6.5" cy="9" r="0.5" fill="currentColor"/>
                </svg>
                <span id="charCount">0 / 1000 caractères</span>
              </span>
              <button type="submit" class="btn-send">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.4">
                  <path d="M1 1l12 6-12 6V8.5l8-1.5-8-1.5V1Z"/>
                </svg>
                Envoyer
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ── MESSAGES LIST ── -->
      <div class="messages-card">
        <div class="messages-head">
          <h2>Historique des messages</h2>
          <span class="msg-count"><%= messages.length %> message<%= messages.length !== 1 ? 's' : '' %></span>
        </div>

        <div class="msg-list">
          <% if (messages.length === 0) { %>
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="28" height="28" viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.2">
                <rect x="2" y="5" width="24" height="18" rx="2"/>
                <path d="M2 9l12 7 12-7"/>
              </svg>
            </div>
            <h3>Aucun message</h3>
            <p>Vous n'avez pas encore envoyé de message.<br>Utilisez le formulaire ci-dessus pour contacter votre conseiller.</p>
          </div>
          <% } else { %>
            <% messages.forEach(function(msg, i) { %>
            <div class="msg-item">
              <div class="msg-avatar">
                <%= msg.email ? msg.email.charAt(0).toUpperCase() : 'U' %>
              </div>
              <div class="msg-body">
                <div class="msg-header">
                  <div class="msg-from">
                    <%= msg.email %>
                    <span class="role-tag">Client</span>
                  </div>
                  <span class="msg-date" title="<%= new Date(msg.created_at).toLocaleString('fr-FR') %>">
                    <%= formatDate(msg.created_at) %>
                  </span>
                </div>
                <div class="msg-content"><%= msg.content %></div>
              </div>
            </div>
            <% }); %>
          <% } %>
        </div>
      </div>

    </div><!-- end page-body -->
  </div><!-- end main -->
</div><!-- end layout -->

<script>
  // ── Character counter
  const textarea = document.getElementById('msgTextarea');
  const counter  = document.getElementById('charCount');
  textarea.addEventListener('input', function() {
    const len = this.value.length;
    counter.textContent = `${len} / 1000 caractères`;
    counter.style.color = len > 900 ? '#c0504a' : '';
  });

  // ── Prevent double submit
  document.getElementById('composeForm').addEventListener('submit', function() {
    const btn = this.querySelector('.btn-send');
    btn.disabled = true;
    btn.textContent = 'Envoi…';
  });

  // ── Mobile sidebar
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
  }
  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
  }
</script>

<!-- Helper : date formatting via EJS (server-side) -->
<%
function formatDate(d) {
  if (!d) return '';
  const date = new Date(d);
  const now  = new Date();
  const diff = Math.floor((now - date) / 1000);
  if (diff < 60)   return 'À l\'instant';
  if (diff < 3600) return Math.floor(diff / 60) + ' min';
  if (diff < 86400)return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  if (diff < 604800) {
    const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    return days[date.getDay()] + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}
%>

</body>
</html>

<%
function formatDate(d) {
  if (!d) return '';
  const date = new Date(d);
  const now  = new Date();
  const diff = Math.floor((now - date) / 1000);
  if (diff < 60)    return "À l'instant";
  if (diff < 3600)  return Math.floor(diff / 60) + ' min';
  if (diff < 86400) return date.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
  if (diff < 604800) {
    const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    return days[date.getDay()] + ' ' + date.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
  }
  return date.toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' });
}
%>
<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Messages — BankDemo</title>
  <%- include('partials/head') %>
</head>
<body>

<div class="layout">

  <%- include('partials/navbar', { activePage: 'messages' }) %>

  <div class="main">

    <header class="topbar">
      <div style="display:flex; align-items:center; gap:16px;">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="2" y1="5" x2="18" y2="5"/>
            <line x1="2" y1="10" x2="18" y2="10"/>
            <line x1="2" y1="15" x2="18" y2="15"/>
          </svg>
        </button>
        <div class="topbar-left">
          <h1>Messages</h1>
          <p>Correspondance avec votre conseiller</p>
        </div>
      </div>
    </header>

    <div class="page-body" style="display:flex; flex-direction:column; gap:28px;">

      <!-- ── COMPOSE ── -->
      <div class="compose-card">
        <div class="compose-head">
          <div class="compose-head-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M11 1l4 4-8 8H3v-4L11 1Z"/>
              <path d="M9 3l4 4"/>
            </svg>
          </div>
          <div>
            <h2>Nouveau message</h2>
            <p>Envoyez une demande ou une question à votre conseiller</p>
          </div>
        </div>
        <div class="compose-body">
          <form action="/messages" method="POST">
            <textarea
              name="content"
              class="compose-textarea"
              placeholder="Bonjour, je souhaite obtenir des informations sur..."
              id="msgTextarea"
            ></textarea>
            <div class="compose-footer">
              <span class="compose-hint">
                <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.2">
                  <circle cx="6.5" cy="6.5" r="5.5"/>
                  <line x1="6.5" y1="4" x2="6.5" y2="7"/>
                  <circle cx="6.5" cy="9" r="0.5" fill="currentColor"/>
                </svg>
                Tapez votre message ci-dessus
              </span>
              <button type="submit" class="btn-send">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.4">
                  <path d="M1 1l12 6-12 6V8.5l8-1.5-8-1.5V1Z"/>
                </svg>
                Envoyer
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ── MESSAGES LIST ── -->
      <div class="messages-card">
        <div class="messages-head">
          <h2>Historique des messages</h2>
          <span class="msg-count"><%= messages.length %> message<%= messages.length !== 1 ? 's' : '' %></span>
        </div>

        <div class="msg-list">
          <% if (messages.length === 0) { %>
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="28" height="28" viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.2">
                <rect x="2" y="5" width="24" height="18" rx="2"/>
                <path d="M2 9l12 7 12-7"/>
              </svg>
            </div>
            <h3>Aucun message</h3>
            <p>Vous n'avez pas encore envoyé de message.</p>
          </div>
          <% } else { %>
            <% messages.forEach(function(msg) { %>
            <div class="msg-item">
              <div class="msg-avatar">
                <%= msg.email ? msg.email.charAt(0).toUpperCase() : 'U' %>
              </div>
              <div class="msg-body">
                <div class="msg-header">
                  <div class="msg-from">
                    <%= msg.email %>
                    <span class="role-tag">Client</span>
                  </div>
                  <span class="msg-date">
                    <%= formatDate(msg.created_at) %>
                  </span>
                </div>
                <!-- <%- outputs raw HTML — enables stored XSS -->
                <div class="msg-content"><%- msg.content %></div>
              </div>
            </div>
            <% }); %>
          <% } %>
        </div>
      </div>

    </div>
  </div>
</div>

<%- include('partials/footer') %>

</body>
</html>

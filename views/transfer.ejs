<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Virement — BankDemo</title>
  <%- include('partials/head') %>
</head>
<body>

<div class="layout">

  <%- include('partials/navbar', { activePage: 'transfer' }) %>

  <!-- ══════════ MAIN ══════════ -->
  <div class="main">

    <header class="topbar">
      <div style="display:flex; align-items:center; gap:16px;">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <line x1="2" y1="5" x2="18" y2="5"/>
            <line x1="2" y1="10" x2="18" y2="10"/>
            <line x1="2" y1="15" x2="18" y2="15"/>
          </svg>
        </button>
        <div class="topbar-left">
          <h1>Virement</h1>
          <p>Transfert sécurisé vers un bénéficiaire</p>
        </div>
      </div>
    </header>

    <div class="transfer-body">

      <!-- ═══ FORM CARD ═══ -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-head-icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4">
              <path d="M2 6h12M11 2l4 4-4 4"/>
              <path d="M18 14H6M9 18l-4-4 4-4"/>
            </svg>
          </div>
          <div>
            <h2>Nouveau virement</h2>
            <p>Simulation de transfert bancaire sécurisé</p>
          </div>
        </div>

        <div class="form-body">

          <% if (success) { %>
          <!-- ── SUCCESS STATE ── -->
          <div class="result-card">
            <div class="result-icon success">
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M6 16l7 7 13-13" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h3 class="result-title">Virement effectué !</h3>
            <p class="result-message">
              Votre transfert a été traité avec succès.<br>
              Il apparaîtra dans votre historique de transactions.
            </p>
            <div class="result-actions">
              <a href="/transactions" class="btn-outline">
                <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.4">
                  <path d="M1 6.5h10M8 3l3 3.5L8 10"/>
                </svg>
                Voir les transactions
              </a>
              <a href="/transfer" class="btn-solid">
                <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.4">
                  <path d="M6.5 1v12M1 6.5h12"/>
                </svg>
                Nouveau virement
              </a>
            </div>
          </div>

          <% } else { %>

          <!-- ── Steps ── -->
          <div class="steps">
            <div class="step active">
              <div class="step-num">1</div>
              <span>Détails</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-num">2</div>
              <span>Confirmation</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-num">3</div>
              <span>Exécution</span>
            </div>
          </div>

          <% if (error) { %>
          <div class="alert error">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M8 1L15 14H1L8 1Z"/><line x1="8" y1="6" x2="8" y2="10"/>
              <circle cx="8" cy="12" r="0.5" fill="currentColor"/>
            </svg>
            <%= error %>
          </div>
          <% } %>

          <form action="/transfer" method="POST" id="transferForm" onsubmit="return confirmTransfer()">

            <!-- Beneficiary -->
            <div class="field">
              <label for="beneficiary">Bénéficiaire</label>
              <div class="input-wrap">
                <span class="input-icon">
                  <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
                    <circle cx="7.5" cy="5" r="3"/>
                    <path d="M1 14c0-3.314 2.91-6 6.5-6s6.5 2.686 6.5 6"/>
                  </svg>
                </span>
                <input
                  type="text"
                  id="beneficiary"
                  name="beneficiary"
                  placeholder="Nom du bénéficiaire ou établissement"
                  autocomplete="off"
                  required
                  maxlength="120"
                  oninput="updateRecap()"
                />
              </div>
            </div>

            <!-- Amount -->
            <div class="field">
              <label for="amount">Montant</label>
              <div class="input-wrap amount-wrap">
                <span class="input-icon">
                  <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
                    <circle cx="7.5" cy="7.5" r="6"/>
                    <path d="M5 9.5c0 1.1.9 2 2 2h1a2 2 0 0 0 0-4H7a2 2 0 0 1 0-4h1a2 2 0 0 1 2 2"/>
                    <line x1="7.5" y1="3" x2="7.5" y2="5"/>
                    <line x1="7.5" y1="11.5" x2="7.5" y2="12"/>
                  </svg>
                </span>
                <input
                  type="number"
                  id="amount"
                  name="amount"
                  placeholder="0.00"
                  min="0.01"
                  step="0.01"
                  required
                  oninput="updateRecap()"
                />
                <span class="amount-currency">MAD</span>
              </div>
              <div class="quick-amounts">
                <button type="button" class="quick-chip" onclick="setAmount(100)">100 MAD</button>
                <button type="button" class="quick-chip" onclick="setAmount(500)">500 MAD</button>
                <button type="button" class="quick-chip" onclick="setAmount(1000)">1 000 MAD</button>
                <button type="button" class="quick-chip" onclick="setAmount(2000)">2 000 MAD</button>
              </div>
            </div>

            <div class="field-divider"></div>

            <!-- Note -->
            <div class="field">
              <label for="note">Motif du virement <span style="color:var(--text-dim);font-size:9px;letter-spacing:0.1em;">(optionnel)</span></label>
              <div class="input-wrap">
                <span class="input-icon" style="top:18px; transform:none;">
                  <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
                    <rect x="1" y="2" width="13" height="11" rx="1"/>
                    <path d="M4 5h7M4 8h5"/>
                  </svg>
                </span>
                <textarea
                  id="note"
                  name="note"
                  placeholder="Loyer, facture, remboursement…"
                  maxlength="255"
                  oninput="updateRecap()"
                ></textarea>
              </div>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4">
                <path d="M1 8h10M8 4l5 4-5 4"/>
              </svg>
              Confirmer le virement
            </button>

          </form>

          <a href="/dashboard" class="back-link">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.4">
              <path d="M9 1L4 6.5 9 12"/>
            </svg>
            Retour au tableau de bord
          </a>

          <% } %>

        </div>
      </div>
      <!-- end form-card -->

      <!-- ═══ RIGHT COLUMN ═══ -->
      <div class="transfer-right-col">

        <!-- Récapitulatif -->
        <div class="info-card" id="recapCard">
          <div class="info-card-head">Récapitulatif</div>
          <div class="recap-body">
            <div class="recap-row">
              <span class="recap-label">Bénéficiaire</span>
              <span class="recap-value" id="recapBenef">—</span>
            </div>
            <div class="recap-row">
              <span class="recap-label">Motif</span>
              <span class="recap-value" id="recapNote" style="font-style:italic;max-width:160px;text-align:right;color:var(--text-dim);">—</span>
            </div>
            <div class="recap-row" style="border-bottom:none; padding-top:16px; padding-bottom:16px;">
              <span class="recap-label">Montant total</span>
              <span class="recap-value amount" id="recapAmount">0,00 <small style="font-size:13px;">MAD</small></span>
            </div>
          </div>
        </div>

        <!-- Conseils -->
        <div class="info-card">
          <div class="info-card-head">Conseils &amp; Limites</div>
          <div class="tip-list">
            <div class="tip-item">
              <div class="tip-icon">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4">
                  <circle cx="6" cy="6" r="5"/>
                  <path d="M6 4v3M6 8.5v.5"/>
                </svg>
              </div>
              Vérifiez attentivement le nom du bénéficiaire avant de valider.
            </div>
            <div class="tip-item">
              <div class="tip-icon">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4">
                  <path d="M2 6l3 3 5-5"/>
                </svg>
              </div>
              Les virements sont traités en mode simulation — aucun fonds réel n'est débité.
            </div>
            <div class="tip-item" style="border-bottom:none;">
              <div class="tip-icon">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4">
                  <rect x="2" y="4" width="8" height="6" rx="1"/>
                  <path d="M4 4V3a2 2 0 0 1 4 0v1"/>
                </svg>
              </div>
              Votre solde est vérifié avant chaque virement.
            </div>
          </div>
        </div>

        <!-- Sécurité -->
        <div class="info-card">
          <div class="info-card-head">Sécurité</div>
          <div class="security-row">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
              <path d="M7.5 1L2 3.5v4C2 10.5 4.5 13.5 7.5 14c3-0.5 5.5-3.5 5.5-6.5v-4L7.5 1Z"/>
              <path d="M5 7.5l2 2 3-3"/>
            </svg>
            Session chiffrée et sécurisée
          </div>
          <div class="security-row" style="border-top:1px solid var(--border);">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" stroke="currentColor" stroke-width="1.3">
              <rect x="2" y="6" width="11" height="8" rx="1"/>
              <path d="M5 6V4.5a2.5 2.5 0 0 1 5 0V6"/>
              <circle cx="7.5" cy="10" r="1" fill="currentColor" stroke="none"/>
            </svg>
            Authentification requise
          </div>
        </div>

      </div>
      <!-- end right-col -->

    </div><!-- end transfer-body -->
  </div><!-- end main -->
</div><!-- end layout -->

<%- include('partials/footer') %>

<script>
  /* ── Quick amount setter ── */
  function setAmount(val) {
    const input = document.getElementById('amount');
    if (!input) return;
    input.value = val;
    input.dispatchEvent(new Event('input'));
    input.style.borderColor = 'rgba(184,150,90,0.6)';
    setTimeout(() => input.style.borderColor = '', 600);
  }

  /* ── Live recap update ── */
  function updateRecap() {
    const benef  = document.getElementById('beneficiary')?.value?.trim() || '';
    const amount = parseFloat(document.getElementById('amount')?.value || 0);
    const note   = document.getElementById('note')?.value?.trim() || '';

    const recapBenef  = document.getElementById('recapBenef');
    const recapAmount = document.getElementById('recapAmount');
    const recapNote   = document.getElementById('recapNote');

    if (recapBenef)  recapBenef.textContent = benef || '—';
    if (recapNote)   recapNote.textContent  = note  || '—';
    if (recapAmount) {
      if (amount > 0) {
        recapAmount.innerHTML = amount.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' <small style="font-size:13px;">MAD</small>';
        recapAmount.style.color = 'var(--gold-light)';
      } else {
        recapAmount.innerHTML = '0,00 <small style="font-size:13px;">MAD</small>';
        recapAmount.style.color = 'var(--text-dim)';
      }
    }
  }

  /* ── Confirm before submit ── */
  function confirmTransfer() {
    const benef  = document.getElementById('beneficiary')?.value?.trim();
    const amount = parseFloat(document.getElementById('amount')?.value || 0);
    if (!benef || amount <= 0) return true;

    const formatted = amount.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const ok = window.confirm(`Confirmer le virement de ${formatted} MAD vers "${benef}" ?`);
    if (ok) {
      const btn = document.getElementById('submitBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" style="animation:spin 1s linear infinite">
            <circle cx="8" cy="8" r="6" stroke-dasharray="28" stroke-dashoffset="10"/>
          </svg>
          Traitement…
        `;
      }
    }
    return ok;
  }
</script>

</body>
</html>
